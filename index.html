
<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Little Secret - Mobile</title>
  <link rel="apple-touch-icon" href="icon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&amp;display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #111827;
      color: #F3F4F6;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    
    h1, h2, h3 {
      color: #60A5FA;
      margin-bottom: 0.5em;
    }
    
    
    ul {
      list-style-type: none;
      padding: 0;
    }
    
    li {
      font-size: 1em;
      margin-top: 15px;
    }
    
    lj {
      color: #60A5FA;
    }
    
    sc {
      color: #111827;
    }
    
    input[type="number"] {
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        width: 45%;
        font-size: 1em;
        background-color: #1F2937;
        color: #F3F4F6;
        text-align: center;
      }
      
      input[type="text"], textarea, modalInput {
        padding: 5px;
        border-radius: 5px;
        margin: 5px 0;
        width: 45%;
        font-size: 1em;
        background-color: #111827;
        color: #F3F4F6;
        text-align: center;
      }
      
      input[type=range] {
        -webkit-appearance: none;
        width: 80%;
        height: 8px;
        margin-bottom: 20px;
        border-radius: 5px;
        background: #E5E7EB;
        outline: none;
        transition: background 0.3s;
      }
      
      input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #60A5FA;
        cursor: pointer;
        transition: transform 0.2s;
      }
      
      input[type=range]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }
      
      input[type=range]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #60A5FA;
        cursor: pointer;
        transition: transform 0.2s;
      }
      
      input[type=range]::-moz-range-thumb:hover {
        transform: scale(1.2);
      }

      button {
        padding: 10px 20px;
        margin: 10px;
        border-radius: 5px;
        border: none;
        background-color: #60A5FA;
        color: #111827;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
    
      button.clicked {
        background-color: #3B82F6 !important;
        box-shadow: 0 0 10px #3B82F6aa;
      }
    
      textarea {
        resize: vertical;
        min-height: 150px;
      }
      
      select {
        background-color: #111827;
        color: #F3F4F6;
        border: none;
        padding: 10px;
        font-size: 1em;
        border-radius: 5px;
        margin: 10px 0;
        width: 80%;
        max-width: 400px;
        box-shadow: 0 0 0 1px #374151 inset;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='20' width='20' viewBox='0 0 20 20'><path d='M7 7l3 3 3-3'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 1em;
        text-align: center;
        text-align-last: center;
      }
      
      select:hover {
        border-color: #F472B6;
        background-color: #FEF2F2;
        color: #000000;
      }
      
      select:focus {
        outline: none;
        border-color: #EC4899;
        color: #000000;
        box-shadow: 0 0 5px rgba(236, 72, 153, 0.5);
      }
      
    #intro {
      height: 90vh;
      width: 90vw;
      background-color: #111827;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-family: 'Dancing Script', cursive;
      color: #60A5FA;
      text-align: center;
      gap: 0;
    }
    
    .title-word {
      display: block;
      line-height: 1;
      position: relative;
    }
    
    .title-word.little {
      top: -1em;
      left: -0.4em;
      font-size: 6em;
    }
    
    .title-word.secret {
      top: -0.8em;
      left: 0.4em;
      font-size: 6em;
    }
  
    .title-word.skip {
      top: 8em;
      font-size: 1.5em;
      font-family: 'Segoe UI', sans-serif;
      color: white;
      animation: pulse 2s infinite;
    }
    
    .screen {
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      position: absolute;
      top: 10;
      left: 10;
      width: 100%;
    }
    
    .screen.visible {
      opacity: 1;
      position: relative;
    }
    
    .reveal-grid {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    
    .reveal-col {
      flex: 1;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
    }
    
    .role-setting {
      display: flex;
      align-items: center;
      gap: 2px;
      margin: 5px 0;
      margin-left: 50px;
    }
    
    .role-setting button {
      padding: 1.5px 4px;
      border: none;
      border-radius: 4px;
      background: #60A5FA;
      color: white;
      cursor: pointer;
      font-size: 0.5em;
    }
    
    .role-setting button:hover {
      background: #60A5FA;
    }
    
    .role-setting button:disabled {
      background: #d1d5db; /* gris clair */
      color: #9ca3af;     /* gris fonc√© */
      cursor: not-allowed;
      transform: none;    /* pas d'effet hover */
    }
    
    /* conteneur principal de la liste */
    #scoreList {
      padding-left: 0;
      margin: 0;
    }
    
    .score-row {
      list-style: none;
      margin-bottom: 16px;
      display: flex;
      justify-content: center; /* centre tout */
    }
    
    .score-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;              /* petit espace fixe entre barre et gain */
    }
    
    .score-bar-container {
      position: relative;
      background-color: #e6e6e6;
      border-radius: 12px;
      height: 24px;
      width: 300px;          /* largeur fixe */
      max-width: 60%;        /* responsive */
      overflow: hidden;
    }
    
    .score-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: 12px 0 0 12px; /* ‚úÖ arrondi uniquement √† gauche */
      background-color: #39A853;
      transition: width 1600ms ease;
      z-index: 1;
    }
    
    .score-content {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 0 16px;
      box-sizing: border-box;
      pointer-events: none;
      color: #000;
      font-weight: 700;
      font-size: 18px;
    }
    
    .score-gain {
      color: #39A853;
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
    }
    
    @keyframes pulse {
      0% { opacity: 0.9; }
      50% { opacity: 0.05; }
      100% { opacity: 0.9; }
    }
    
    #setup, #tableRound, #votePhase, #reveal {
      display: none;
      max-width: 600px;
      margin: auto;
      background-color: #1F2937;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00000088;
    }
    #names, #options, #chooseStarter {
      max-width: 600px;
      margin: auto;
      background-color: #1F2937;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00000088;
    }

    #role, #word, #players {
      font-size: 2em;
      margin-top: 10px;
      font-weight: bold;
    }
    #timer {
      color: #FBBF24;
      font-weight: bold;
      margin-top: 10px;
    }

  </style>
</head>
<body>

  <div id="intro" class="screen visible">
    <span class="title-word little">Little</span>
    <span class="title-word secret">Secret</span>
        <span class="title-word skip">Touchez pour commencer</span>
  </div>
  
  <div id="start" class="screen" style="display: none;">
    <h1>Little Secret</h1>
  
    <p>üë§ Nombre de joueurs : <span id="playerCountLabel">5</span></p>
      <input type="range" id="playerCount" min="3" max="15" value="5"
             oninput="updatePlayerCountLabel(this.value)" onchange="updateRoleDistribution()" />
    
      <!-- R√¥les affich√©s sur une seule ligne -->
      <div class="role-setting">
              <span>ü§ì Disciples :</span>
              <span id="discipleCount">3</span>
            </div>
      
      <div class="role-setting">
        <span>ü´£ Infiltr√©s :</span>
        <button id="spyMinus" onclick="adjustRole('spy', -1)">‚àí</button>
        <span id="spyCount">1</span>
        <button id="spyPlus" onclick="adjustRole('spy', 1)">+</button>
      </div>
      
      <div class="role-setting">
        <span>üïµÔ∏è‚Äç‚ôÇÔ∏è Journalistes :</span>
        <button id="journalistMinus" onclick="adjustRole('journalist', -1)">‚àí</button>
        <span id="journalistCount">1</span>
        <button id="journalistPlus" onclick="adjustRole('journalist', 1)">+</button>
      </div>
  
    <!-- Ligne en 2 colonnes -->
    <div style="display: flex; justify-content: space-between; gap: 1em; margin-top: 20px;">
      <div style="flex:1;">
              <p>üèÜ Points n√©cessaires pour gagner</p>
              <select id="pointsToWin">
                <option value="3">3 points</option>
                <option value="5" selected>5 points</option>
                <option value="7">7 points</option>
                <option value="9">9 points</option>
                <option value="11">11 points</option>
                <option value="13">13 points</option>
                <option value="15">15 points</option>
              </select>
            </div>
      <div style="flex:1;">
        <p>‚è≥ Temps d'affichage du r√¥le</p>
        <select id="displayDuration">
          <option value="3">3 secondes</option>
          <option value="5">5 secondes</option>
          <option value="7">7 secondes</option>
          <option value="10" selected>10 secondes</option>
          <option value="15">15 secondes</option>
          <option value="20">20 secondes</option>
          <option value="25">25 secondes</option>
          <option value="30">30 secondes</option>
        </select>
      </div>
    </div>
  
    <div style="display: flex; justify-content: space-between; margin-top: 45px; gap: 1em;">
      <button onclick="openOptions()">Options</button>
      <button onclick="prepareNames()">Nouvelle partie</button>
    </div>
  </div>

  <div id="options" style="display: none;">
  <h2>Modifier les mots</h2>

    <label for="difficultySelect">Choisir la difficult√© :</label>
    <select id="difficultySelect" onchange="updateWordEditor()">
      <option value="facile">Facile</option>
      <option value="interm√©diaire">Interm√©diaire</option>
      <option value="difficile">Difficile</option>
      <option value="personnalis√©e">Personnalis√©e</option>
    </select>
    <div style="display: flex; gap: 1em; margin-top: 1em;">
      <div style="flex: 1;">
        <h3>Mot secret</h3>
        <textarea id="discipleWordsInput" rows="20" style="width: 90%;"></textarea>
      </div>
      <div style="flex: 1;">
        <h3>Equivalent</h3>
        <textarea id="infiltr√©WordsInput" rows="20" style="width: 90%;"></textarea>
      </div>
    </div>
    
    <div style="margin-top: 1em; display: flex; justify-content: center; gap: 1em;">
          <button onclick="mainMenu()">Retour</button>
          <button onclick="saveOptions()">Sauvegarder</button>
    </div>
  </div>
  
  <div id="names" style="display:none;">
    <h2>Inscrire le nom des joueurs</h2>
    <form id="namesForm"></form>
    <div style="text-align: center; margin-bottom: 1em;">
      <button onclick="clearSavedNames()">Effacer les noms enregistr√©s</button>
    </div>
    <div style="margin-top: 1em; display: flex; justify-content: center; gap: 1em;">
      <button onclick="mainMenu()">Retour</button>
      <button onclick="submitNames()">Suivant</button>
    </div>
  </div>
  
  <div id="chooseStarter" style="display:none;">
    <h2>Ordre de passage</h2>
    <label for="starterSelect">S√©lection du premier joueur :</label>
    <br>
    <select id="starterSelect"></select>
    <br><br>
    <div style="display: flex; justify-content: space-between; gap: 0em;">
      <button onclick="nameMenu()">Retour</button>
      <button onclick="startDistribution()">D√©marrer la partie</button>
    </div>
  </div>

  <div id="setup" style="display: none;">
    <h2>Attribution des mots...</h2>
    <div id="players"></div>
    <p id="info">Clique sur le bouton ci-dessous pour d√©couvrir ton mot.</p>
    <div id="word">‚¨õ‚¨õ‚¨õ</div>
    <div id="timer"></div>
    <button id="toggleButton" onclick="toggleRole()">Voir mon mot</button>
  </div>
  
  <div id="tableRound" style="display: none;">
    <h2>Tour de table</h2>
    <p id="roundInstruction">Chaque joueur en jeu donne un indice oral sur son mot.</p>
    <button onclick="goToVoting()">Passer au vote</button>
  </div>
  
  <div id="votePhase" style="display: none;">
    <h2>Vote</h2>
    <p>Quel joueur souhaitez-vous √©liminer ?</p>
    <div id="voteList"></div>
  </div>

  <div id="reveal" style="display: none;">
    <h2>Phase de r√©v√©lation</h2>
    <p id="revealbis" style="display:none;">Voici comment les r√¥les et les mots ont √©t√© distribu√©s :</p>
    <div id="revealWords" class="reveal-grid"></div>
    <ul id="revealList"></ul>
    <div id="replayButtons" style="display: none; justify-content: center; gap: 1em;">
      <button onclick="showScores()">Tableau des scores</button>
    </div>
    <button class="reveal-toggle" onclick="showRevealPhase()">R√©v√©ler tous les r√¥les</button>
  </div>
  
  <div id="scoreBoard" style="display:none;">
    <h2>Tableau des scores</h2>
    <ul id="scoreList"></ul>
    <div style="margin-top: 1em;">
      <button onclick="restartGame(true)">Menu principal</button>
      <button onclick="replaySamePlayers()">Rejouer</button>
    </div>
  </div>
  
  <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:45%; background-color:rgba(0,0,0,0.8); z-index:10; align-items:center; justify-content:center;">
    <div id="modalContent" style="background:#1F2937; color:white; padding:20px; border-radius:10px; max-width:90%; text-align:center;">
      <p id="modalMessage"></p>
      <input id="modalInput" style="display:none; margin-top:10px; padding:5px; border-radius: 5px; width: 93%; font-size: 1em; background-color: #111827; color: #F3F4F6; text-align: center;" />
      <div style="margin-top:20px;">
        <button onclick="closeModal(true)">Suivant</button>
      </div>
    </div>
  </div>

  <script>
    const wordLists = {
      facile: {
        disciples: ["Chat", "Avion", "Bouteille", "Lune", "Arbre", "Marteau", "Nuage", "Fromage", "Serpent", "Radio", "Pluie", "T√©l√©phone", "Montagne", "Papier", "√âlectricit√©", "Requin", "Chaise", "Chocolat", "Feu", "Robot"],
        infiltrees: ["Tigre", "H√©licopt√®re", "Carafe", "Soleil", "Buisson", "Tournevis", "Fum√©e", "Yaourt", "Anguille", "Enceinte", "Neige", "Talkie-walkie", "Colline", "Carton", "Magn√©tisme", "Dauphin", "Fauteuil", "Nutella", "Braise", "Cyborg"]
      },
      interm√©diaire: {
        disciples: ["Musique", "Banque", "Montagne", "Ordinateur", "Plage"],
        infiltrees: ["Chanson", "Argent", "Colline", "√âcran", "Sable"]
      },
      difficile: {
        disciples: ["M√©taphore", "Abstraction", "√âthique", "Philosophie", "Conscience"],
        infiltrees: ["Comparaison", "Concret", "Morale", "Id√©ologie", "Subconscient"]
      },
      personnalis√©e: {
        disciples: [],
        infiltrees: []
      }
    };
    
    let selectedDifficulty = "facile";
    const journalisteMessage = "‚ùå Aucun mot ‚ùå ";

    let rolesPool = [];
    let motSecret = "";
    let motPiege = "";
    let allRoles = [];
    let revealedRoles = [];
    let currentRole = "";
    let showing = false;
    let timer = null;
    let countdown = 0;
    let displaySeconds = 10;
    let playerNumber = 1;
    let playerNames = [];
    let orderedPlayerNames = [];
    let currentPlayers = []; // joueurs encore en jeu
    let eliminatedPlayers = []; // joueurs √©limin√©s
    let modalCallback = null;
    let playerScores = {}; // { nom: score }
    let firstPlayerIndex = null;
    let roundScores = {};
    let currentAudio = null;

    function getRandomFromArray(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function openOptions() {
      document.getElementById("start").style.display = "none";
      document.getElementById("options").style.display = "block";
    
      document.getElementById("difficultySelect").value = selectedDifficulty;
      updateWordEditor();
    }
    
    function updateWordEditor() {
      selectedDifficulty = document.getElementById("difficultySelect").value;
    
      const discipleArea = document.getElementById("discipleWordsInput");
      const infilArea = document.getElementById("infiltr√©WordsInput");
    
      const list = wordLists[selectedDifficulty];
    
      discipleArea.value = list.disciples.join("\n");
      infilArea.value = list.infiltrees.join("\n");
    
      const editable = selectedDifficulty === "personnalis√©e";
      discipleArea.disabled = !editable;
      infilArea.disabled = !editable;
    }
    
    function saveOptions() {
      if (selectedDifficulty === "personnalis√©e") {
        const discipleText = document.getElementById("discipleWordsInput").value.trim();
        const infilText = document.getElementById("infiltr√©WordsInput").value.trim();
    
        wordLists.personnalis√©e.disciples = discipleText.split("\n").map(w => w.trim()).filter(w => w);
        wordLists.personnalis√©e.infiltrees = infilText.split("\n").map(w => w.trim()).filter(w => w);
    
        // Sauvegarde locale
        localStorage.setItem("customDisciples", JSON.stringify(wordLists.personnalis√©e.disciples));
        localStorage.setItem("customInfiltrees", JSON.stringify(wordLists.personnalis√©e.infiltrees));
      }
    
      document.getElementById("options").style.display = "none";
      document.getElementById("start").style.display = "block";
      
      localStorage.setItem("selectedDifficulty", selectedDifficulty);
    }

    function mainMenu() {
      document.getElementById("names").style.display = "none";
      document.getElementById("options").style.display = "none";
      document.getElementById("start").style.display = "block";
    }
    
    function nameMenu() {
          document.getElementById("chooseStarter").style.display = "none";
          document.getElementById("names").style.display = "block";
        }
        
    function updatePlayerCountLabel(value) {
      document.getElementById("playerCountLabel").textContent = value;
    }
    
    function updateRoleDistribution() {
      const total = parseInt(document.getElementById("playerCount").value);
    
      // ‚úÖ toujours au moins 1 infiltr√©
      const spies = Math.max(1, Math.floor(total / 2 - 1.5));
      const journ = Math.min(1, Math.max(0, total - 4));
    
      document.getElementById("spyCount").textContent = spies;
      document.getElementById("journalistCount").textContent = journ;
      document.getElementById("discipleCount").textContent = total - spies - journ;
    
      updateRoleButtons();
    }
    
    function adjustRole(type, delta) {
      const total = parseInt(document.getElementById("playerCount").value);
      let spies = parseInt(document.getElementById("spyCount").textContent);
      let journ = parseInt(document.getElementById("journalistCount").textContent);
    
      if (type === "spy") spies += delta;
      if (type === "journalist") journ += delta;
    
      // ‚úÖ limites corrig√©es
      if (spies < 1) spies = 1;   // toujours au moins 1 infiltr√©
      if (journ < 0) journ = 0;   // journaliste peut dispara√Ætre compl√®tement
    
      const disciples = total - spies - journ;
    
      if (disciples < 2) return; // au moins 2 disciples
    
      document.getElementById("spyCount").textContent = spies;
      document.getElementById("journalistCount").textContent = journ;
      document.getElementById("discipleCount").textContent = disciples;
    
      updateRoleButtons();
    }
    
    function updateRoleButtons() {
      const total = parseInt(document.getElementById("playerCount").value);
      const spies = parseInt(document.getElementById("spyCount").textContent);
      const journ = parseInt(document.getElementById("journalistCount").textContent);
      const disciples = total - spies - journ;
    
      const spyPlus = document.getElementById("spyPlus");
      const spyMinus = document.getElementById("spyMinus");
      const journalistPlus = document.getElementById("journalistPlus");
      const journalistMinus = document.getElementById("journalistMinus");
    
      // ‚úÖ condition stricte : il doit rester plus de disciples que d'infiltr√©s+journalistes
      const canAdd = (spies + journ) < (disciples - 1);
    
      // boutons + d√©sactiv√©s si contrainte non respect√©e
      spyPlus.disabled = !canAdd;
      journalistPlus.disabled = !canAdd;
    
      // boutons - selon les minimums
      spyMinus.disabled = spies <= 1;        // min 1 infiltr√©
      journalistMinus.disabled = journ <= 0; // min 0 journaliste
    }
    
    function prepareNames() {
      const totalPlayers = parseInt(document.getElementById("playerCount").value, 10); // range/select -> .value OK
      const spyCount = parseInt(document.getElementById("spyCount").textContent, 10); // ‚úÖ span -> textContent
      const journalistCount = parseInt(document.getElementById("journalistCount").textContent, 10); // ‚úÖ span
      displaySeconds = parseInt(document.getElementById("displayDuration").value, 10);
    
      // S√©curit√© : il faut au moins 2 disciples
      const disciples = totalPlayers - spyCount - journalistCount;
      if (disciples < 2) {
        showModal("Il doit rester au moins 2 disciples. Ajuste les r√¥les.", false, () => {});
        return;
      }
    
      // Formulaire des noms
      const nameForm = document.getElementById("namesForm");
      nameForm.innerHTML = "";
      const savedNames = JSON.parse(localStorage.getItem("playerNames") || "[]");
      for (let i = 1; i <= totalPlayers; i++) {
        const value = savedNames[i - 1] ? `value="${savedNames[i - 1]}"` : "";
        nameForm.innerHTML += `
          <p>Joueur ${i} : <input type="text" name="player${i}" required placeholder="Nom ou pseudo" maxlength="10" ${value}></p>
        `;
      }
    
      document.getElementById("start").style.display = "none";
      document.getElementById("names").style.display = "block";
    
      // Pool des r√¥les
      rolesPool = [];
      for (let i = 0; i < spyCount; i++) rolesPool.push("ü´£ Infiltr√©");
      for (let i = 0; i < journalistCount; i++) rolesPool.push("üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste");
      for (let i = 0; i < disciples; i++) rolesPool.push("ü§ì Disciple");
    
      shuffleArray(rolesPool);
      allRoles = rolesPool.slice(); // ‚úÖ copie du m√©lange
    }

    function submitNames() {
      const inputs = document.querySelectorAll("#namesForm input");
      playerNames = [];

      for (let input of inputs) {
        if (input.value.trim() === "") {
          showModal("Tous les joueurs doivent avoir un nom.", false, () => {});
          return;
        }
        playerNames.push(input.value.trim());
        localStorage.setItem("playerNames", JSON.stringify(playerNames));
      }

      document.getElementById("names").style.display = "none";
      document.getElementById("chooseStarter").style.display = "block";
      
      const select = document.getElementById("starterSelect");
      select.innerHTML = "";
      playerNames.forEach((name, index) => {
        if (!(name in playerScores)) playerScores[name] = 0;
        const option = document.createElement("option");
        option.value = index;
        option.text = name;
        select.appendChild(option);
      });
    }
    
    function clearSavedNames() {
      localStorage.removeItem("playerNames");
    
      const inputs = document.querySelectorAll("#namesForm input");
      inputs.forEach(input => input.value = "");
    }
    
    function startDistribution() {
      const startIndex = parseInt(document.getElementById("starterSelect").value, 10);
    
      // Ordre des joueurs √† partir du starter choisi
      orderedPlayerNames = playerNames.slice(startIndex).concat(playerNames.slice(0, startIndex));
    
      // ‚úÖ ne pas re-shuffler ici : on prend le m√©lange pr√©par√©
      rolesPool = allRoles.slice();
    
      revealedRoles = [];
      playerNumber = 1;
    
      // Tirage du couple de mots li√© (m√™me index, al√©a sur l'attribution)
      const list = wordLists[selectedDifficulty];
      const index = Math.floor(Math.random() * list.disciples.length);
      if (Math.random() < 0.5) {
        motSecret = list.disciples[index];
        motPiege  = list.infiltrees[index];
      } else {
        motSecret = list.infiltrees[index];
        motPiege  = list.disciples[index];
      }
    
      // Affiche l‚Äô√©cran de distribution
      document.getElementById("chooseStarter").style.display = "none";
      document.getElementById("setup").style.display = "block";
      document.getElementById("toggleButton").innerText = "Voir mon mot";
      document.getElementById("players").innerText = "";
      document.getElementById("word").innerText = "‚¨õ‚¨õ‚¨õ";
      document.getElementById("timer").innerText = "";
      showing = false;
    }
    
    function toggleRole() {
      document.getElementById("toggleButton").disabled = true; // √©vite double clic
      setTimeout(() => {
        handleToggleClick();
        document.getElementById("toggleButton").disabled = false;
      }, 500); // d√©lai de 500ms
    }

    function handleToggleClick() {
      if (!showing) {
        currentRole = rolesPool.pop();
        const currentName = orderedPlayerNames[playerNumber - 1];
        revealedRoles.push({ joueur: currentName, role: currentRole });
        playerNumber++;
        let wordShown = "";

        if (currentRole === "ü§ì Disciple") {
          wordShown = motSecret;
        } else if (currentRole === "ü´£ Infiltr√©") {
          wordShown = motPiege;
        } else {
          wordShown = journalisteMessage;
        }

        document.getElementById("players").innerText = `${currentName}`;
        document.getElementById("word").innerText = wordShown;
        document.getElementById("info").innerText = "Souviens-toi de ton mot.";
        document.getElementById("toggleButton").innerText = "Cacher mon mot";
        showing = true;

        startCountdown(displaySeconds);
      } else {
        hideRole();
      }
    }

    function startCountdown(seconds) {
      countdown = seconds;
      document.getElementById("timer").innerText = `Masquage dans ${countdown} secondes...`;

      timer = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(timer);
          hideRole();
        } else {
          document.getElementById("timer").innerText = `Masquage dans ${countdown} secondes...`;
        }
      }, 1000);
    }

    function hideRole() {
      clearInterval(timer);
      const currentName = orderedPlayerNames[playerNumber - 1];
      document.getElementById("players").innerText = "";
      document.getElementById("word").innerText = "‚¨õ‚¨õ‚¨õ";
      document.getElementById("info").innerText = `Passe l'appareil √† ${currentName}`;
      document.getElementById("toggleButton").innerText = "Voir mon mot";
      document.getElementById("timer").innerText = "";
      showing = false;
      if (rolesPool.length === 0) {
          document.getElementById("setup").style.display = "none";
          currentPlayers = [...revealedRoles]; // initialiser la liste des survivants
          showTableRound();
        }
    }
    
    function showTableRound() {
      document.getElementById("votePhase").style.display = "none";
      document.getElementById("tableRound").style.display = "block";
    
      let chosen;
    
      if (firstPlayerIndex === null) {
        // üé≤ Premier tour ‚Üí choix al√©atoire hors journaliste
        const nonJournalistes = currentPlayers.filter(p => p.role !== "üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste");
        if (nonJournalistes.length > 0) {
          const randomIndex = Math.floor(Math.random() * nonJournalistes.length);
          chosen = nonJournalistes[randomIndex];
          firstPlayerIndex = currentPlayers.indexOf(chosen); // on sauvegarde sa position
        }
      } else {
        // Tours suivants ‚Üí on reprend le joueur d√©j√† d√©termin√©
        chosen = currentPlayers[firstPlayerIndex];
      }
    
      if (chosen) {
        document.getElementById("roundInstruction").innerHTML =
          `üé≤ En commen√ßant par <strong>${chosen.joueur}</strong>, chaque joueur donne un indice sur son mot<br>`;
      }
    }
    
    function goToVoting() {
      document.getElementById("tableRound").style.display = "none";
      document.getElementById("votePhase").style.display = "block";
    
      const voteList = document.getElementById("voteList");
      voteList.innerHTML = "";
    
      if (currentPlayers.length === 0) return;
    
      // D√©cale la liste de mani√®re √† ce que firstPlayerIndex soit en premier
      const rotatedPlayers = currentPlayers
        .slice(firstPlayerIndex)
        .concat(currentPlayers.slice(0, firstPlayerIndex));
    
      rotatedPlayers.forEach((p) => {
        const btn = document.createElement("button");
        btn.textContent = `${p.joueur}`;
    
        // ‚ö†Ô∏è Attention : l'index affich√© doit correspondre √† currentPlayers, pas rotatedPlayers
        const originalIndex = currentPlayers.indexOf(p);
        btn.onclick = () => handleVote(originalIndex);
    
        voteList.appendChild(btn);
      });
    }
    
    function handleVote(index) {
      const eliminated = currentPlayers[index];
    
      showModal(`üó≥ ${eliminated.joueur} √©tait ${eliminated.role}`, false, () => {
        if (eliminated.role === "üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste") {
          showModal("Quel est le mot des disciples ?", true, (guess) => {
            if (guess && guess.toLowerCase() === motSecret.toLowerCase()) {
              eliminated.guessSuccess = true;
              showModal("üéâ Bonne r√©ponse !<br><br>Victoire du journaliste !", false, () => {});
              playSound("sounds/journalist_win.mp3");
              return endVotePhase();
            } else {
              // ‚ùå Mauvaise r√©ponse ‚Üí on √©limine le journaliste
              currentPlayers.splice(index, 1);
              eliminatedPlayers.push(eliminated);
    
              // D√©finir qui commence au prochain tour
              if (currentPlayers.length > 0) {
                firstPlayerIndex = index % currentPlayers.length;
              } else {
                firstPlayerIndex = null;
              }
    
              showModal("‚ùå Mauvaise r√©ponse ! ‚ùå <br><br>Le journaliste a √©t√© d√©couvert !", false, () => {});
              playSound("sounds/fail.mp3");
              return handleVoteSuite();
            }
          });
        } else {
          // √âlimination d‚Äôun autre r√¥le
          currentPlayers.splice(index, 1);
          eliminatedPlayers.push(eliminated);
    
          // D√©finir qui commence au prochain tour
          if (currentPlayers.length > 0) {
            firstPlayerIndex = index % currentPlayers.length;
          } else {
            firstPlayerIndex = null;
          }
    
          handleVoteSuite();
        }
      });
    }
    
    function handleVoteSuite() {
      const disciples = currentPlayers.filter(p => p.role === "ü§ì Disciple");
      const infiltr√©s = currentPlayers.filter(p => p.role === "ü´£ Infiltr√©");
      const journalistes = currentPlayers.filter(p => p.role === "üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste");
    
      // Cas 1 : Plus que 2 joueurs et seulement 1 disciple
      if (currentPlayers.length === 2 && disciples.length === 1) {
        const autre = currentPlayers.find(p => p.role !== "ü§ì Disciple");
    
        if (autre.role === "ü´£ Infiltr√©") {
          // ‚û°Ô∏è infiltr√© gagne
          showModal("üìâ Il reste encore 1 infiltr√© parmi les 2 joueurs restants.<br><br> Victoire de l'infiltr√© !", false, endVotePhase("infiltr√©s"));
          return;
        }
    
        if (autre.role === "üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste") {
          // ‚û°Ô∏è journaliste doit deviner
          showModal("üìâ Il reste encore 1 journaliste parmi les 2 joueurs restants.<br><br>Le journaliste doit deviner le mot des disciples pour gagner !", true, (guess) => {
            if (guess && guess.toLowerCase() === motSecret.toLowerCase()) {
              autre.guessSuccess = true;
              showModal("üéâ Bonne r√©ponse !<br><br>Victoire du journaliste !", false, endVotePhase("journalistes"));
            } else {
              showModal("‚ùå Mauvaise r√©ponse !<br><br>Victoire du disciple !", false, endVotePhase("disciples"));
            }
          });
          return;
        }
      }
    
      // Cas 2 : Tous les infiltr√©s √©limin√©s ET tous les journalistes √©limin√©s ‚Üí disciples gagnent
      if (infiltr√©s.length === 0 && journalistes.length === 0) {
        showModal("Tous les journalistes et infiltr√©s sont √©limin√©s !<br><br>Victoire des disciples !", false, endVotePhase);
        return;
      }
    
      // Cas 3 : Tous les disciples √©limin√©s ‚Üí infiltr√©s gagnent
      if (disciples.length === 0 && infiltr√©s.length > 0) {
        showModal("Tous les disciples sont √©limin√©s !<br><br>Victoire des infiltr√©s !", false, endVotePhase);
        return;
      }
    
      // Cas 4 : Plus d‚Äôinfiltr√©s ET plus de disciples ‚Üí seuls journalistes restants
      if (infiltr√©s.length === 0 && disciples.length === 0 && journalistes.length > 0) {
        showModal("Tous les infiltr√©s et disciples sont √©limin√©s !<br><br>Victoire des journalistes !", false, endVotePhase);
        return;
      }
    
      // Sinon : nouvelle manche
      showTableRound();
    }
    
    function endVotePhase(forcedWinner = null) {
      document.getElementById("votePhase").style.display = "none";
      document.getElementById("tableRound").style.display = "none";
      document.getElementById("reveal").style.display = "block";
    
      const disciplesRestants = currentPlayers.filter(p => p.role === "ü§ì Disciple");
      const infiltr√©sRestants = currentPlayers.filter(p => p.role === "ü´£ Infiltr√©");
      const journalistesRestants = currentPlayers.filter(p => p.role === "üïµÔ∏è‚Äç‚ôÇÔ∏è Journaliste");
      const journalisteGagnant = currentPlayers.find(p => p.guessSuccess);
    
      roundScores = {};
    
      // ‚úÖ Cas sp√©cial (transmis depuis handleVoteSuite)
      if (forcedWinner === "infiltr√©s") {
        infiltr√©sRestants.forEach(p => {
          playerScores[p.joueur] += 2;
          roundScores[p.joueur] = 2;
        });
      } else if (forcedWinner === "disciples") {
        disciplesRestants.forEach(p => {
          playerScores[p.joueur] += 1;
          roundScores[p.joueur] = 1;
        });
      } else if (forcedWinner === "journalistes") {
        journalistesRestants.forEach(p => {
          playerScores[p.joueur] += 3;
          roundScores[p.joueur] = 3;
        });
      }
    
      // ‚úÖ Cas g√©n√©ral (quand pas de forcedWinner)
      else if (journalisteGagnant) {
        playerScores[journalisteGagnant.joueur] += 3;
        roundScores[journalisteGagnant.joueur] = 3;
      } else if (infiltr√©sRestants.length > 0 && disciplesRestants.length === 0) {
        infiltr√©sRestants.forEach(p => {
          playerScores[p.joueur] += 2;
          roundScores[p.joueur] = 2;
        });
      } else if (disciplesRestants.length > 0 && infiltr√©sRestants.length === 0 && journalistesRestants.length === 0) {
        disciplesRestants.forEach(p => {
          playerScores[p.joueur] += 1;
          roundScores[p.joueur] = 1;
        });
      } else if (infiltr√©sRestants.length === 0 && disciplesRestants.length === 0 && journalistesRestants.length > 0) {
        journalistesRestants.forEach(p => {
          playerScores[p.joueur] += 3;
          roundScores[p.joueur] = 3;
        });
      }
    
      document.getElementById("revealList").innerHTML =
        "<li>‚úÖ Les votes sont √† pr√©sent termin√©s.<br><br>Cliquez sur le bouton ci-dessous pour r√©v√©ler les r√¥les.</li>";
      document.getElementById("revealList").style.fontWeight = "bold";
    }

    function showRevealPhase() {
      document.getElementById("setup").style.display = "none";
      document.getElementById("reveal").style.display = "block";
      document.getElementById("revealbis").style.display = "block";
    
      // Afficher les mots des disciples et infiltr√©s en 2 colonnes
      
      const wordsDiv = document.getElementById("revealWords");
      wordsDiv.innerHTML = "";
      wordsDiv.innerHTML = `
        <div class="reveal-col">Mot des<br>Disciples<br><span style="color:#10B981;">${motSecret}</span></div>
        <div class="reveal-col">Mot des<br>Infiltr√©s<br><span style="color:#EF4444;">${motPiege}</span></div>
      `;
    
      // Afficher la liste des joueurs avec leur r√¥le
      const list = document.getElementById("revealList");
      list.innerHTML = "";
      revealedRoles.forEach(entry => {
        list.innerHTML += `<li>üë§ ${entry.joueur} ‚Äî <lj>${entry.role}</lj></li>`;
      });
    
      // Supprimer le bouton "R√©v√©ler tous les r√¥les"
      const revealBtn = document.querySelector("#reveal button.reveal-toggle");
      if (revealBtn) revealBtn.remove();
    
      // Afficher les vrais boutons
      document.getElementById("replayButtons").style.display = "flex";
    }
    
    function showScores() {
      document.getElementById("reveal").style.display = "none";
      document.getElementById("scoreBoard").style.display = "block";
    
      const list = document.getElementById("scoreList");
      list.innerHTML = "";
    
      // R√©affiche le bouton Rejouer par d√©faut
      const replayBtn = Array.from(document.querySelectorAll("#scoreBoard button"))
        .find(btn => btn.textContent.includes("Rejouer"));
      if (replayBtn) replayBtn.style.display = "inline-block";
    
      // Trie d√©croissant
      const sortedPlayers = Object.entries(playerScores).sort((a, b) => b[1] - a[1]);
    
      const maxScore = sortedPlayers.length > 0 ? Math.max(1, sortedPlayers[0][1]) : 1;
    
      let winners = [];
      const pointsToWin = parseInt(document.getElementById("pointsToWin").value, 10);
    
      sortedPlayers.forEach(([nom, score], i) => {
        const gain = roundScores && roundScores[nom] ? `(+${roundScores[nom]})` : "";
        const widthPercent = Math.round((score / maxScore) * 100);
        // si on arrive √† 100%, pousser un peu plus loin
        const finalWidth = widthPercent >= 100 ? 100.5 + "%" : widthPercent + "%";
    
        // ‚úÖ largeur initiale √† 0%
        const row = document.createElement("sc");
        row.classList.add("score-row");
        row.innerHTML = `
          <div class="score-wrapper">
            <div class="score-bar-container">
              <div class="score-bar" style="width: 0%;"></div>
              <div class="score-content">
                <span class="score-left">${escapeHtml(nom)}</span>
                <span class="score-right">${score} pts</span>
              </div>
            </div>
            ${gain ? `<span class="score-gain">${gain}</span>` : `(+0)`}
          </div>
        `;
        list.appendChild(row);
    
        // ‚úÖ appliquer la vraie largeur apr√®s un petit d√©lai ‚Üí animation
        setTimeout(() => {
          const bar = row.querySelector(".score-bar");
          bar.style.width = finalWidth;
        }, 100 * i); // petit d√©calage entre joueurs (effet cascade)
        
        if (score >= pointsToWin) winners.push(nom);
      });
    
      if (winners.length > 0) {
        const message = winners.length === 1
          ? `${winners[0]} a gagn√© la partie ! üéâ`
          : `üèÜ Les gagnants sont : ${winners.join(", ")} !`;
    
        if (replayBtn) replayBtn.style.display = "none";
        showModal(message, false, () => {});
      }
    }
    
    // petite utilitaire pour √©viter injection si noms contiennent < >
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m];
      });
    }
    
    function replaySamePlayers() {
      rolesPool = [];
      revealedRoles = [];
      playerNumber = 1;
      firstPlayerIndex = null;
      document.getElementById("info").innerText = `Clique sur le bouton ci-dessous pour d√©couvrir ton mot`;
    
      shuffleArray(allRoles);
      rolesPool = [...allRoles];
    
      const list = wordLists[selectedDifficulty];
      const index = Math.floor(Math.random() * list.disciples.length);
      motSecret = list.disciples[index];
      motPiege = list.infiltrees[index];
    
      document.getElementById("reveal").style.display = "none";
      document.getElementById("revealbis").style.display = "none";
      document.getElementById("revealWords").innerHTML = "";
      document.getElementById("scoreBoard").style.display = "none";
      document.getElementById("replayButtons").style.display = "none";
      document.getElementById("chooseStarter").style.display = "block";
      insertRevealButton();
      showing = false;
    }
    
    function restartGame(resetScores = false) {
        rolesPool = [];
        revealedRoles = [];
        playerNumber = 1;
        firstPlayerIndex = null;
        document.getElementById("info").innerText = `Clique sur le bouton ci-dessous pour d√©couvrir ton mot`;
        
      // Affiche l'√©cran principal
      const currentName = playerNames[playerNumber - 1];
      document.getElementById("scoreBoard").style.display = "none";
      document.getElementById("reveal").style.display = "none";
      document.getElementById("setup").style.display = "none";
      document.getElementById("names").style.display = "none";
      document.getElementById("options").style.display = "none";
      document.getElementById("start").style.display = "block";
      document.getElementById("revealList").innerHTML = "";
      document.getElementById("revealWords").innerHTML = "";
      document.getElementById("replayButtons").style.display = "none";
      document.getElementById("revealbis").style.display = "none";
      
      if (resetScores) {
          playerScores = {};
        }
      
      insertRevealButton();
    }
    
    function insertRevealButton() {
      const reveal = document.getElementById("reveal");
    
      // V√©rifie qu'il n'existe pas d√©j√†
      if (!document.querySelector("#reveal button.reveal-toggle")) {
        const btn = document.createElement("button");
        btn.className = "reveal-toggle";
        btn.innerText = "R√©v√©ler tous les r√¥les";
        btn.onclick = showRevealPhase;
    
        // Ins√®re en haut de la div "reveal" (avant les boutons de replay)
        reveal.insertBefore(btn, document.getElementById("replayButtons"));
      }
    }
    
    window.onload = function () {
    // R√©cup√®re le pointsToWin sauvegard√©
      const savedPoints = localStorage.getItem("pointsToWin");
      if (savedPoints) {
        document.getElementById("pointsToWin").value = savedPoints;
      }
    
      // Ajoute un listener pour sauvegarder d√®s qu‚Äôon change la valeur
      document.getElementById("pointsToWin").addEventListener("change", function() {
        localStorage.setItem("pointsToWin", this.value);
      });
      
      const savedCustomD = localStorage.getItem("customDisciples");
      const savedCustomI = localStorage.getItem("customInfiltrees");
      
      if (savedCustomD && savedCustomI) {
        try {
          wordLists.personnalis√©e.disciples = JSON.parse(savedCustomD);
          wordLists.personnalis√©e.infiltrees = JSON.parse(savedCustomI);
        } catch (e) {
          console.warn("Erreur lors du chargement des mots personnalis√©s", e);
        }
      }
      
      const savedDifficulty = localStorage.getItem("selectedDifficulty");
      if (savedDifficulty && wordLists[savedDifficulty]) {
        selectedDifficulty = savedDifficulty;
      }
      
    };
    
    window.onload = () => {
      updateRoleDistribution(); // initialise les valeurs + boutons au lancement
    };
    
    document.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        btn.classList.add("clicked");
        setTimeout(() => btn.classList.remove("clicked"), 150);
      });
    });
    
    window.addEventListener("load", () => {
      const intro = document.getElementById("intro");
      intro.addEventListener("click", () => {
      fadeToStart();
      });
    });
    
    function fadeToStart() {
      const intro = document.getElementById("intro");
      const start = document.getElementById("start");
    
      intro.classList.remove("visible");
      start.style.display = "block";
    
      setTimeout(() => {
        start.classList.add("visible");
      }, 800);
    
      setTimeout(() => {
        intro.style.display = "none";
      }, 800);
    }
    
    function showModal(message, withInput = false, callback = null) {
      document.getElementById("modalMessage").innerHTML = message;
      const input = document.getElementById("modalInput");
      input.style.display = withInput ? "block" : "none";
      input.value = "";
      modalCallback = callback;
      document.getElementById("modal").style.display = "flex";
    }
    
    function closeModal(ok) {
      const input = document.getElementById("modalInput");
      const withInput = input.style.display !== "none";
      document.getElementById("modal").style.display = "none";
    
      if (modalCallback) {
        if (ok) {
          modalCallback(withInput ? input.value.trim() : true);
          modalCallback(value);
        } else {
          modalCallback(null);
        }
      }
      modalCallback = null;
    }
    
    function playSound(path) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      currentAudio = new Audio(path);
      currentAudio.volume = 0.7;
      currentAudio.play();
    }
          
  </script>

</body>
</html>
